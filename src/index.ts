import { ChatService } from "./chat/chat-service.js";
import { SessionStore } from "./chat/session-store.js";
import { loadConfig } from "./config.js";
import { startTelegramBot } from "./bots/telegram-bot.js";
import type { RuntimeProviderInfo } from "./bots/model-list.js";
import { createProviderRegistry } from "./providers/provider-registry.js";
import { dirname, join } from "node:path";

async function main(): Promise<void> {
  const config = loadConfig();
  const providers = createProviderRegistry(config);
  if (providers.size === 0) {
    throw new Error("No providers are configured.");
  }

  const sessions = new SessionStore(
    config.defaultProvider,
    config.maxHistory,
    config.sessionStorePath,
  );
  const chatService = new ChatService(sessions, providers, config.systemPrompt);
  const runtimeInfo: RuntimeProviderInfo = {
    codex: {
      command: config.codex.command,
      model: config.codex.model,
    },
    claude: {
      command: config.claude.command,
      model: config.claude.model,
    },
  };
  const stoppers: Array<() => Promise<void>> = [];
  const ownerStorePath = join(dirname(config.sessionStorePath), "owner.json");

  stoppers.push(
    await startTelegramBot(
      config.telegramBotToken,
      chatService,
      config.streamEditIntervalMs,
      runtimeInfo,
      ownerStorePath,
    ),
  );

  console.log(
    `[openshell] Running with providers: ${[...providers.keys()].join(", ")}`,
  );
  console.log(`[openshell] Session store: ${config.sessionStorePath}`);
  console.log(
    `[openshell] Restored chat sessions: ${sessions.getSessionCount()}`,
  );
  console.log("[openshell] 오픈쉘이 실행중입니다.");

  let shuttingDown = false;
  const shutdown = async (signal: NodeJS.Signals): Promise<void> => {
    if (shuttingDown) {
      return;
    }
    shuttingDown = true;
    console.log(`[openshell] Received ${signal}, shutting down...`);
    await Promise.all(stoppers.map((stop) => stop()));
    process.exit(0);
  };

  process.on("SIGINT", () => {
    void shutdown("SIGINT");
  });
  process.on("SIGTERM", () => {
    void shutdown("SIGTERM");
  });
}

main().catch((error: unknown) => {
  console.error("[openshell] Failed to start:", error);
  process.exit(1);
});
